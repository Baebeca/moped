function Mopidy(e){return this instanceof Mopidy?(this._settings=this._configure(e||{}),this._console=this._getConsole(),this._backoffDelay=this._settings.backoffDelayMin,this._pendingRequests={},this._webSocket=null,bane.createEventEmitter(this),this._delegateEvents(),this._settings.autoConnect&&this.connect(),void 0):new Mopidy(e)}if(("function"==typeof define&&define.amd&&function(e){define("bane",e)}||"object"==typeof module&&function(e){module.exports=e()}||function(e){this.bane=e()})(function(){"use strict";function e(e,t,n){var r,i=n.length;if(i>0)for(r=0;i>r;++r)n[r](e,t);else setTimeout(function(){throw t.message=e+" listener threw error: "+t.message,t},0)}function t(e){if("function"!=typeof e)throw new TypeError("Listener is not function");return e}function n(e){return e.supervisors||(e.supervisors=[]),e.supervisors}function r(e,t){return e.listeners||(e.listeners={}),t&&!e.listeners[t]&&(e.listeners[t]=[]),t?e.listeners[t]:e.listeners}function i(e){return e.errbacks||(e.errbacks=[]),e.errbacks}function o(o){function s(t,n,r){try{n.listener.apply(n.thisp||o,r)}catch(a){e(t,a,i(o))}}return o=o||{},o.on=function(e,i,o){return"function"==typeof e?n(this).push({listener:e,thisp:i}):(r(this,e).push({listener:t(i),thisp:o}),void 0)},o.off=function(e,t){var o,a,s,u;if(!e){o=n(this),o.splice(0,o.length),a=r(this);for(s in a)a.hasOwnProperty(s)&&(o=r(this,s),o.splice(0,o.length));return o=i(this),o.splice(0,o.length),void 0}if("function"==typeof e?(o=n(this),t=e):o=r(this,e),!t)return o.splice(0,o.length),void 0;for(s=0,u=o.length;u>s;++s)if(o[s].listener===t)return o.splice(s,1),void 0},o.once=function(e,t,n){var r=function(){o.off(e,r),t.apply(this,arguments)};o.on(e,r,n)},o.bind=function(e,t){var n,r,i;if(t)for(r=0,i=t.length;i>r;++r){if("function"!=typeof e[t[r]])throw new Error("No such method "+t[r]);this.on(t[r],e[t[r]],e)}else for(n in e)"function"==typeof e[n]&&this.on(n,e[n],e);return e},o.emit=function(e){var t,i,o=n(this),u=a.call(arguments);for(t=0,i=o.length;i>t;++t)s(e,o[t],u);for(o=r(this,e).slice(),u=a.call(arguments,1),t=0,i=o.length;i>t;++t)s(e,o[t],u)},o.errback=function(e){this.errbacks||(this.errbacks=[]),this.errbacks.push(t(e))},o}var a=Array.prototype.slice;return{createEventEmitter:o}}),"undefined"!=typeof window&&(window.define=function(e){try{delete window.define}catch(t){window.define=void 0}window.when=e()},window.define.amd={}),function(define,e){"use strict";define(function(require){function t(e,t,n,i){return r(e).then(t,n,i)}function n(e,t){this._message=e,this.inspect=t}function r(e){return a(function(t){t(e)})}function i(e){return t(e,l)}function o(){function e(e,o,a){t.resolve=t.resolver.resolve=function(t){return i?r(t):(i=!0,e(t),n)},t.reject=t.resolver.reject=function(e){return i?r(l(e)):(i=!0,o(e),n)},t.notify=t.resolver.notify=function(e){return a(e),e}}var t,n,i;return t={promise:V,resolve:V,reject:V,notify:V,resolver:{resolve:V,reject:V,notify:V}},t.promise=n=a(e),t}function a(e){return s(e,R.PromiseStatus&&R.PromiseStatus())}function s(e,t){function r(e,t,n,r){function i(i){i._message(e,t,n,r)}p?p.push(i):D(function(){i(c)})}function i(){return c?c.inspect():N()}function o(e){p&&(c=d(e),m(p,c),p=V,t&&g(c,t))}function a(e){o(l(e))}function s(e){p&&m(p,f(e))}var u,c,p=[];u=new n(r,i),u._status=t;try{e(o,a,s)}catch(h){a(h)}return u}function u(e){return c(new p(e),function(){return S(e)})}function l(e){return c(new h(e),function(){return _(e)})}function c(e,t){return new n(function(t,n,r){try{r(e[t].apply(e,n))}catch(i){r(l(i))}},t)}function f(e){return new n(function(t,n,r,i){var o=n[2];try{i("function"==typeof o?o(e):e)}catch(a){i(a)}})}function d(e){return e instanceof n?e:e===Object(e)&&"then"in e?a(function(t,n,r){D(function(){try{var i=e.then;"function"==typeof i?P(i,e,t,n,r):t(u(e))}catch(o){n(o)}})}):u(e)}function p(e){this.value=e}function h(e){this.reason=e}function m(e,t){D(function(){for(var n,r=0;n=e[r++];)n(t)})}function g(e,t){function n(){t.fulfilled()}function r(e){t.rejected(e)}e.then(n,r)}function v(e){return e&&"function"==typeof e.then}function y(e,n,r,i,o){return t(e,function(e){function s(r,i,o){function a(e){p(e)}function s(e){d(e)}var u,l,c,f,d,p,h,m;if(h=e.length>>>0,u=Math.max(0,Math.min(n,h)),c=[],l=h-u+1,f=[],u)for(p=function(e){f.push(e),--l||(d=p=j,i(f))},d=function(e){c.push(e),--u||(d=p=j,r(c))},m=0;h>m;++m)m in e&&t(e[m],s,a,o);else r(c)}return a(s).then(r,i,o)})}function b(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return y(e,1,i,n,r)}function w(e,t,n,r){return C(e,j).then(t,n,r)}function x(){return C(arguments,j)}function k(e){return C(e,S,_)}function T(e,t){return C(e,t)}function C(e,n,r){return t(e,function(e){function i(i,o,a){function s(e,s){t(e,n,r).then(function(e){u[s]=e,a(e),--c||i(u)},o)}var u,l,c,f;if(c=l=e.length>>>0,u=[],!c)return i(u),void 0;for(f=0;l>f;f++)f in e?s(e[f],f):--c}return s(i)})}function E(e,n){var r=P(M,arguments,1);return t(e,function(e){var i;return i=e.length,r[0]=function(e,r,o){return t(e,function(e){return t(r,function(t){return n(e,t,o,i)})})},O.apply(e,r)})}function S(e){return{state:"fulfilled",value:e}}function _(e){return{state:"rejected",reason:e}}function N(){return{state:"pending"}}function D(e){1===I.push(e)&&$(A)}function A(){for(var e,t=0;e=I[t++];)e();I=[]}function j(e){return e}t.promise=a,t.resolve=r,t.reject=i,t.defer=o,t.join=x,t.all=w,t.map=T,t.reduce=E,t.settle=k,t.any=b,t.some=y,t.isPromise=v,t.isPromiseLike=v,n.prototype={then:function(){var e,t;return e=arguments,t=this._message,s(function(n,r,i){t("when",e,n,i)},this._status&&this._status.observed())},otherwise:function(e){return this.then(V,e)},ensure:function(e){function t(){return r(e())}return this.then(t,t).yield(this)},yield:function(e){return this.then(function(){return e})},tap:function(e){return this.then(e).yield(this)},spread:function(e){return this.then(function(t){return w(t,function(t){return e.apply(V,t)})})},always:function(e,t){return this.then(e,e,t)}},p.prototype.when=function(e){return"function"==typeof e?e(this.value):this.value},h.prototype.when=function(e,t){if("function"==typeof t)return t(this.reason);throw this.reason};var O,M,P,$,I,L,F,H,B,R,q,V;if(q=require,I=[],L=e.setTimeout,R="undefined"!=typeof console?console:t,"function"==typeof setImmediate)$=setImmediate.bind(e);else if("undefined"!=typeof MessageChannel){var W=new MessageChannel;W.port1.onmessage=A,$=function(){W.port2.postMessage(0)}}else if("object"==typeof process&&process.nextTick)$=process.nextTick;else try{$=q("vertx").runOnLoop||q("vertx").runOnContext}catch(z){$=function(e){L(e,0)}}return F=Function.prototype,H=F.call,P=F.bind?H.bind(H):function(e,t){return e.apply(t,M.call(arguments,2))},B=[],M=B.slice,O=B.reduce||function(e){var t,n,r,i,o;if(o=0,t=Object(this),i=t.length>>>0,n=arguments,n.length<=1)for(;;){if(o in t){r=t[o++];break}if(++o>=i)throw new TypeError}else r=n[1];for(;i>o;++o)o in t&&(r=e(r,t[o],o,t));return r},t})}("function"==typeof define&&define.amd?define:function(e){module.exports=e(require)},this),"object"==typeof module&&"function"==typeof require)var bane=require("bane"),websocket=require("faye-websocket"),when=require("when");Mopidy.WebSocket="object"==typeof module&&"function"==typeof require?websocket.Client:window.WebSocket,Mopidy.prototype._configure=function(e){var t="undefined"!=typeof document&&document.location.host||"localhost";return e.webSocketUrl=e.webSocketUrl||"ws://"+t+"/mopidy/ws/",e.autoConnect!==!1&&(e.autoConnect=!0),e.backoffDelayMin=e.backoffDelayMin||1e3,e.backoffDelayMax=e.backoffDelayMax||64e3,e},Mopidy.prototype._getConsole=function(){var e="undefined"!=typeof e&&e||{};return e.log=e.log||function(){},e.warn=e.warn||function(){},e.error=e.error||function(){},e},Mopidy.prototype._delegateEvents=function(){this.off("websocket:close"),this.off("websocket:error"),this.off("websocket:incomingMessage"),this.off("websocket:open"),this.off("state:offline"),this.on("websocket:close",this._cleanup),this.on("websocket:error",this._handleWebSocketError),this.on("websocket:incomingMessage",this._handleMessage),this.on("websocket:open",this._resetBackoffDelay),this.on("websocket:open",this._getApiSpec),this.on("state:offline",this._reconnect)},Mopidy.prototype.connect=function(){if(this._webSocket){if(this._webSocket.readyState===Mopidy.WebSocket.OPEN)return;this._webSocket.close()}this._webSocket=this._settings.webSocket||new Mopidy.WebSocket(this._settings.webSocketUrl),this._webSocket.onclose=function(e){this.emit("websocket:close",e)}.bind(this),this._webSocket.onerror=function(e){this.emit("websocket:error",e)}.bind(this),this._webSocket.onopen=function(){this.emit("websocket:open")}.bind(this),this._webSocket.onmessage=function(e){this.emit("websocket:incomingMessage",e)}.bind(this)},Mopidy.prototype._cleanup=function(e){Object.keys(this._pendingRequests).forEach(function(t){var n=this._pendingRequests[t];delete this._pendingRequests[t],n.reject({message:"WebSocket closed",closeEvent:e})}.bind(this)),this.emit("state:offline")},Mopidy.prototype._reconnect=function(){this.emit("reconnectionPending",{timeToAttempt:this._backoffDelay}),setTimeout(function(){this.emit("reconnecting"),this.connect()}.bind(this),this._backoffDelay),this._backoffDelay=2*this._backoffDelay,this._backoffDelay>this._settings.backoffDelayMax&&(this._backoffDelay=this._settings.backoffDelayMax)},Mopidy.prototype._resetBackoffDelay=function(){this._backoffDelay=this._settings.backoffDelayMin},Mopidy.prototype.close=function(){this.off("state:offline",this._reconnect),this._webSocket.close()},Mopidy.prototype._handleWebSocketError=function(e){this._console.warn("WebSocket error:",e.stack||e)},Mopidy.prototype._send=function(e){var t=when.defer();switch(this._webSocket.readyState){case Mopidy.WebSocket.CONNECTING:t.resolver.reject({message:"WebSocket is still connecting"});break;case Mopidy.WebSocket.CLOSING:t.resolver.reject({message:"WebSocket is closing"});break;case Mopidy.WebSocket.CLOSED:t.resolver.reject({message:"WebSocket is closed"});break;default:e.jsonrpc="2.0",e.id=this._nextRequestId(),this._pendingRequests[e.id]=t.resolver,this._webSocket.send(JSON.stringify(e,function(e,t){return"__observable__"===e?void 0:t})),this.emit("websocket:outgoingMessage",e)}return t.promise},Mopidy.prototype._nextRequestId=function(){var e=-1;return function(){return e+=1}}(),Mopidy.prototype._handleMessage=function(e){try{var t=JSON.parse(e.data);t.hasOwnProperty("id")?this._handleResponse(t):t.hasOwnProperty("event")?this._handleEvent(t):this._console.warn("Unknown message type received. Message was: "+e.data)}catch(n){if(!(n instanceof SyntaxError))throw n;this._console.warn("WebSocket message parsing failed. Message was: "+e.data)}},Mopidy.prototype._handleResponse=function(e){if(!this._pendingRequests.hasOwnProperty(e.id))return this._console.warn("Unexpected response received. Message was:",e),void 0;var t=this._pendingRequests[e.id];delete this._pendingRequests[e.id],e.hasOwnProperty("result")?t.resolve(e.result):e.hasOwnProperty("error")?(t.reject(e.error),this._console.warn("Server returned error:",e.error)):(t.reject({message:"Response without 'result' or 'error' received",data:{response:e}}),this._console.warn("Response without 'result' or 'error' received. Message was:",e))},Mopidy.prototype._handleEvent=function(e){var t=e.event,n=e;delete n.event,this.emit("event:"+this._snakeToCamel(t),n)},Mopidy.prototype._getApiSpec=function(){return this._send({method:"core.describe"}).then(this._createApi.bind(this),this._handleWebSocketError).then(null,this._handleWebSocketError)},Mopidy.prototype._createApi=function(e){var t=function(e){return function(){var t=Array.prototype.slice.call(arguments);return this._send({method:e,params:t})}.bind(this)}.bind(this),n=function(e){var t=e.split(".");return t.length>=1&&"core"===t[0]&&(t=t.slice(1)),t},r=function(e){var t=this;return e.forEach(function(e){e=this._snakeToCamel(e),t[e]=t[e]||{},t=t[e]}.bind(this)),t}.bind(this),i=function(i){var o=n(i),a=this._snakeToCamel(o.slice(-1)[0]),s=r(o.slice(0,-1));s[a]=t(i),s[a].description=e[i].description,s[a].params=e[i].params}.bind(this);Object.keys(e).forEach(i),this.emit("state:online")},Mopidy.prototype._snakeToCamel=function(e){return e.replace(/(_[a-z])/g,function(e){return e.toUpperCase().replace("_","")})},"object"==typeof exports&&(exports.Mopidy=Mopidy);